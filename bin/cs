#! /bin/bash
set -e

usage() {
  if [ -n "$1" ]; then
    echo "$1" >&2
    echo      >&2
  fi

  cat >&2 <<EOF
"USAGE: cs [options] <pattern> <pattern> ..."
  -d <dir>  Only search in <dir> (may be specified multiple times).
  -i        Perform a case-insensitive search.
  -x <ext>  Only search on files named *.<ext> (may be specified multiple times).
EOF
  exit 1
}

OPTS=("--exclude-dir=.git")
while getopts "d:x:i" opt; do
  case "$opt" in
    d) DIRS+=("$OPTARG");;
    x) EXTS+=("--include=*.$OPTARG");;
    i) OPTS+=("-i");;
  esac
done

shift $((OPTIND-1))
for arg in "$@"; do
  PATS+=("-e" "$arg")
done

if [ ${#PATS[@]} -eq 0 ]; then
  usage "No pattern given!"
fi

if [ ${#DIRS[@]} -eq 0 ]; then
  DIRS+=(".")
fi

grep -Irn --color=auto "${OPTS[@]}" "${EXTS[@]}" "${PATS[@]}" "${DIRS[@]}"
